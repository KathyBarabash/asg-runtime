# ASG Runtime Library

[![Python Version](https://img.shields.io/badge/python-3.12-blue.svg)](https://www.python.org/downloads/release/python-3120/)
<!-- [![License: MIT](https://img.shields.io/badge/license-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![Status: Alpha](https://img.shields.io/badge/status-alpha-lightgrey.svg)]() -->

ASG Runtime is a Python library providing runtime support for SFDPs (Shared Federated Data Products) generated with the ASG tool.  
This library handles the heavy lifting needed to realize SFDP functionality, while allowing SFDP servers to stay slim and uniform through templating.

## Features

ASG Runtime provides support for:

- [x] Parsing endpoint specifications generated by the ASG-tool.
- [x] Fetching data from origin FDPs using async `httpx`, supporting timeouts, retries, pagination, and caching headers.
- [x] Realizing data transformations as prescribed by the endpoint specification, including loading and invoking methods from the `transforms` library.
- [ ] **TODO:** Observing and managing the `transforms` library at runtime.
- [x] Two-level caching:  
  - `origin cache` to store responses from origin FDPs,  
  - `response cache` to store computed SFDP responses.
- [x] Providing operational statistics, including cache hits/misses, HTTP client stats, etc.
- [ ] **TODO:** Publishing telemetry in Prometheus-compatible format.
- [x] Returning data from SFDP endpoints as ORJSON-encoded datasets.
- [x] Logging and error reporting.

## Usage

The library is designed to be present in environments where ASG-generated SFDPs are deployed.

Installation can be done from sources using standard Python methods, such as:
- Installing directly from a Git repository,
- Installing from local sources,
- Installing from a built package.

For detailed usage instructions on local usage, see [docs/local_usage.md](./docs/local_usage.md).

At the moment, no public installable package is planned.  

Additionally, the library is packaged into a pre-baked container image used by the ASG system to create templated SFDP instances. To use the image, use the following in your SFDP's Dockerfile:

```sh
# for the latest build
FROM registry.teadal.ubiwhere.com/teadal-public-images/asg-runtime:latest

# for the concrete release
FROM registry.teadal.ubiwhere.com/teadal-public-images/asg-runtime:<version> 
```

## Repository Structure

```text
asg-runtime/
├── README.md           # this file :-)
├── pyproject.toml      # Build system configuration
├── .env                # Example environment file
├── Dockerfile          # Used to create base asg-runtime image (used by CI)
├── .github/            # Github CI workflows
├── asg_runtime/        # Library sources
│   ├── caches/         # Cache modules
│   ├── gin/            # Gin dependencies
│   ├── http/           # HTTP access modules
│   ├── models/         # Shared data structures
│   ├── serializers/    # Object serialization modules
│   ├── telemetry/      # TODO: Telemetry modules
│   ├── utils/          # Shared utilities (e.g., logging)
│   ├
│   ├── __init__.py     # Mininal required exports 
│   ├── executor.py     # Main library logic (Executor class)
│   └── gin_helper.py   # Helper for data request processing (depends on GIN)
├── docs/               # Documentation
├── test/               # Pytest tests, organized by topic
│   ├── pytest.ini      # Pytest configuration
│   ├── conftest.py     # Pytest fixtures
│   ├── 00_settings/
│   ├── 01_spec/
│   ├── 02_serializer/
│   ├── 03_caches/
│   ├── 04_httpx/
│   ├── 05_gin_helper/
│   ├── 06_executor/
│   ├── app.py          # Test app acting as dependent SFDP
│   └── transforms/     # Transformation methods used by the test SFDP
```

## Contributing

To contribute to the library, you can 
- Open issues to report on problems or to suggest features and improvements
- Submit PRs

## Releases

The library releases are versioned to help keeping the whole ASG system that includes the ASG-tool for generating the templated ASG-SFDP apps, the generated apps, and the ASG Library. Release process is described in [./docs/release.md](./docs/release.md).

## Status

Current commit [63d916d3](https://github.com/KathyBarabash/asg-runtime/commit/89678fd1dc7e904a3f88534a228c70da63d916d3requires) leaves the following to be done:

- redo the test suite to support the refactored settings model 
- improve startup errors reporting, in particular:
  - Value error, origin_cache_lru_max_items must be set for backend 'lru'
  - ImportError: The 'diskcache' package is required for disk caching.
  - redis.exceptions.ConnectionError: ... connecting to localhost:6379.
- figure out the bytes_served computation for app_stats
  ```
  "app": {
      "requests_received": 2,
      "requests_failed": 0,
      "requests_served": 2,
      "bytes_served": 1629942,
      "processing_time": 27.66
    },
  ```
- address code quality (ruff,etc.)